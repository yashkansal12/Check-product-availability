{% extends "base.html" %}

{% block title %}User Requests - {{ shop.shop_name }}{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
<style>
body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
.card-custom { border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); padding: 20px; margin-top: 30px; }
.table-hover tbody tr:hover { background-color: #e2f0d9; }
.btn-sm { padding: 4px 10px; font-size: 0.85rem; }
.reply-input { width: 140px; display: inline-block; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card card-custom">
        <h3>User Requests for {{ shop.shop_name }}</h3>
        {% if requests %}
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Item</th>
                        <th>Quantity</th>
                        <th>Status</th>
                        <th>Reply</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for req in requests %}
                    <tr id="req-{{ req.id }}">
                        <td>{{ req.user.username }}</td>
                        <td>{% if req.item %}{{ req.item.name }}{% else %}{{ req.item_name }}{% endif %}</td>
                        <td>{{ req.quantity }}</td>
                        <td class="status">{{ req.status }}</td>
                        <td class="reply">{{ req.reply_message|default:"-" }}</td>
                        <td>
                            {% if req.status == "Pending" %}
                            <input type="text" class="form-control form-control-sm reply-input" placeholder="Reply...">
                            <button class="btn btn-success btn-sm action-btn" data-id="{{ req.id }}" data-status="Approved"><i class="fa fa-check"></i></button>
                            <button class="btn btn-danger btn-sm action-btn" data-id="{{ req.id }}" data-status="Rejected"><i class="fa fa-times"></i></button>
                            <button class="btn btn-primary btn-sm reply-btn" data-id="{{ req.id }}"><i class="fa fa-reply"></i></button>
                            {% else %}
                            <small class="text-muted">Replied</small>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-center text-muted">No user requests yet.</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const csrftoken = document.cookie.split('; ').find(row => row.startsWith('csrftoken'))?.split('=')[1];

function sendUpdate(id, data) {
    fetch(`/request/${id}/reply/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": csrftoken,
            "X-Requested-With": "XMLHttpRequest",
        },
        body: new URLSearchParams(data)
    })
    .then(res => res.json())
    .then(resp => {
        if(resp.success){
            const row = document.getElementById(`req-${id}`);
            if(resp.status) row.querySelector(".status").innerText = resp.status;
            if(resp.reply_message) row.querySelector(".reply").innerText = resp.reply_message;
        } else {
            alert(resp.error || "Failed to update");
        }
    })
    .catch(() => alert("Server error"));
}

// Approve / Reject buttons
document.querySelectorAll(".action-btn").forEach(btn => {
    btn.addEventListener("click", function() {
        const id = this.dataset.id;
        const status = this.dataset.status;
        sendUpdate(id, {status: status});
    });
});

// Reply buttons
document.querySelectorAll(".reply-btn").forEach(btn => {
    btn.addEventListener("click", function() {
        const id = this.dataset.id;
        const input = this.previousElementSibling.previousElementSibling;
        const reply = input.value.trim();
        if(!reply) { alert("Reply cannot be empty"); return; }
        sendUpdate(id, {reply_message: reply});
        input.value = "";
    });
});
</script>
{% endblock %}
