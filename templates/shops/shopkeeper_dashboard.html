{% extends "base.html" %}
{% load static %}

{% block title %}Shopkeeper Dashboard{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

<style>
    body { background:#f4f6f9; font-family:'Segoe UI'; }
    .d-none { display:none; }

    /* Sidebar */
    .sidebar {
        position:fixed; top:0; left:0;
        height:100vh; width:230px;
        background:#198754; color:#fff;
        padding:20px 15px;
    }
    .sidebar h3 { font-size:1.6rem; font-weight:bold; margin-bottom:25px; }
    .sidebar a {
        display:flex; align-items:center;
        color:white; text-decoration:none;
        margin:12px 0; padding:10px;
        border-radius:8px;
    }
    .sidebar a:hover { background:rgba(255,255,255,0.2); }

    /* Top shop name */
    .shop-name-top-left {
        position:fixed; left:250px; top:15px;
        background:#e6f4ea; padding:8px 18px;
        font-size:1.6rem; font-weight:bold;
        color:#198754;
        border-radius:12px;
        box-shadow:0 5px 12px rgba(0,0,0,0.15);
    }

    /* Main page content */
    .main { margin-left:250px; padding:30px; }

    .card-custom {
        background:white; padding:20px;
        border-radius:12px;
        margin-bottom:25px;
        box-shadow:0 6px 18px rgba(0,0,0,0.08);
    }

    .table thead {
        background:#198754;
        color:white;
    }
    .table-hover tbody tr:hover { background:#e2f0d9; }
</style>
{% endblock %}


{% block content %}

<!-- ---------------- SIDEBAR ---------------- -->
<div class="sidebar">
    <h3><i class="fa fa-store"></i> {{ request.user.shop.shop_name }}</h3>
    <a onclick="showSection('dashboard')"><i class="fa fa-home"></i> Dashboard</a>
    <a onclick="showSection('requests')"><i class="fa fa-envelope"></i> User Requests</a>
    <a onclick="showSection('profile')"><i class="fa fa-user"></i> Profile</a>
    <a onclick="showSection('transactions')"><i class="fa fa-shopping-cart"></i> Transactions</a>
    <a href="{% url 'shops:custom_logout' %}"><i class="fa fa-sign-out-alt"></i> Logout</a>
</div>

<div class="shop-name-top-left">{{ request.user.shop.shop_name }}</div>

<!-- ---------------- MAIN PAGE ---------------- -->
<div class="main">

<!-- ====================== DASHBOARD ====================== -->
<div id="dashboard-section">

    <!-- ---------- ADD PRODUCT ---------- -->
    <div class="card-custom">
        <h4><i class="fa fa-plus-circle"></i> Add New Product</h4>

        <form method="POST" enctype="multipart/form-data" class="row g-3 mt-2">
            {% csrf_token %}
            <input type="hidden" name="add_product" value="1">

            <div class="col-md-4">
                <input type="text" name="name" class="form-control" placeholder="Product Name" required>
            </div>

            <div class="col-md-2">
                <input type="number" name="quantity" class="form-control" placeholder="Qty" required>
            </div>

            <div class="col-md-2">
                <input type="number" step="0.01" name="price" class="form-control" placeholder="Price ₹" required>
            </div>

            <div class="col-md-4">
                <input type="text" name="description" class="form-control" placeholder="Description">
            </div>

            <!-- ⭐ IMAGE FIELD -->
            <div class="col-md-4">
                <input type="file" name="image" class="form-control" accept="image/*">
            </div>

            <div class="col-12">
                <button class="btn btn-success w-100">➕ Add Product</button>
            </div>
        </form>
    </div>

    <!-- ---------- SEARCH ---------- -->
    <input type="text" id="productSearch" class="form-control mb-3" placeholder="Search product..." onkeyup="filterProducts()">

    <!-- ---------- PRODUCT TABLE ---------- -->
    <div class="card-custom">
        <h4><i class="fa fa-box"></i> My Products</h4>

        <div class="table-responsive mt-3">
            <table class="table table-hover align-middle" id="productsTable">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Qty</th>
                        <th>Price</th>
                        <th>Actions</th>
                    </tr>
                </thead>

                <tbody>
                    {% for item in items %}
                    <tr id="row-{{ item.item_id }}">

                        <!-- PRODUCT IMAGE -->
                        <td>
                            {% if item.image %}
                                <img src="{{ item.image.url }}" width="70" height="70" style="border-radius:8px; object-fit:cover;">
                            {% else %}
                                <img src="{% static 'no_image.png' %}" width="70" height="70" style="border-radius:8px; object-fit:cover;">
                            {% endif %}
                        </td>

                        <!-- NAME -->
                        <td>
                            <span id="name-display-{{ item.item_id }}">{{ item.name }}</span>
                            <input id="name-input-{{ item.item_id }}" class="form-control d-none" value="{{ item.name }}">
                        </td>

                        <!-- DESCRIPTION -->
                        <td>
                            <span id="desc-display-{{ item.item_id }}">{{ item.description }}</span>
                            <input id="desc-input-{{ item.item_id }}" class="form-control d-none" value="{{ item.description }}">
                        </td>

                        <!-- QUANTITY -->
                        <td>
                            <span id="qty-display-{{ item.item_id }}">{{ item.quantity }}</span>
                            <input type="number" id="qty-input-{{ item.item_id }}" class="form-control d-none" value="{{ item.quantity }}">
                        </td>

                        <!-- PRICE -->
                        <td>
                            <span id="price-display-{{ item.item_id }}">{{ item.price }}</span>
                            <input type="number" step="0.01" id="price-input-{{ item.item_id }}" class="form-control d-none" value="{{ item.price }}">
                        </td>

                        <!-- ACTIONS -->
                        <td>
                            <button class="btn btn-sm btn-outline-primary" id="edit-btn-{{ item.item_id }}" onclick="editRow({{ item.item_id }})">Edit</button>
                            <button class="btn btn-sm btn-outline-success d-none" id="save-btn-{{ item.item_id }}" onclick="saveEdit({{ item.item_id }})">Save</button>

                            <form method="POST" action="{% url 'shops:delete_product' item.item_id %}" style="display:inline;">
                                {% csrf_token %}
                                <button class="btn btn-sm btn-outline-danger"><i class="fa fa-trash"></i></button>
                            </form>
                        </td>

                    </tr>
                    {% empty %}
                    <tr><td colspan="6" class="text-center text-muted">No products yet.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>


<!-- ====================== USER REQUESTS ====================== -->
<div id="requests-section" class="d-none">
    <div class="card-custom">
        <h4><i class="fa fa-envelope"></i> User Requests</h4>

        <table class="table table-hover mt-3">
            <thead>
                <tr>
                    <th>User</th>
                    <th>Item</th>
                    <th>Qty</th>
                    <th>Status</th>
                    <th>Reply</th>
                    <th>Actions</th>
                </tr>
            </thead>

            <tbody>
                {% for req in requests %}
                <tr id="req-{{ req.id }}">
                    <td>{{ req.user.username }}</td>
                    <td>{{ req.item.name }}</td>
                    <td>{{ req.quantity }}</td>

                    <td>
                        <span class="badge bg-success">{{ req.status }}</span>
                    </td>

                    <td id="reply-{{ req.id }}">{{ req.reply_message }}</td>

                    <td>
                        <input id="reply-input-{{ req.id }}" class="form-control form-control-sm mb-1" placeholder="Reply...">
                        <button class="btn btn-sm btn-success" onclick="handleRequest({{ req.id }}, 'approve')">Approve</button>
                        <button class="btn btn-sm btn-danger" onclick="handleRequest({{ req.id }}, 'reject')">Reject</button>
                        <button class="btn btn-sm btn-primary" onclick="handleRequest({{ req.id }}, 'reply')">Reply</button>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="text-center text-muted">No requests yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>


<!-- ====================== PROFILE ====================== -->
<div id="profile-section" class="d-none">
    <div class="card-custom">
        <h4><i class="fa fa-user"></i> Profile</h4>

        <form method="POST">
            {% csrf_token %}
            <input type="hidden" name="update_profile" value="1">

            <div class="row g-3 mt-2">
                <div class="col-md-6"><input name="username" class="form-control" value="{{ request.user.username }}"></div>
                <div class="col-md-6"><input name="email" class="form-control" value="{{ request.user.email }}"></div>

                <div class="col-md-6"><input name="shop_name" class="form-control" value="{{ request.user.shop.shop_name }}"></div>
                <div class="col-md-6"><input name="phone" class="form-control" value="{{ request.user.profile.phone }}"></div>

                <div class="col-12"><input name="address" class="form-control" value="{{ request.user.profile.address }}"></div>
            </div>

            <button class="btn btn-success mt-3">Save Profile</button>
        </form>
    </div>
</div>


<!-- ====================== TRANSACTIONS ====================== -->
<div id="transactions-section" class="d-none">
    <div class="card-custom">
        <h4><i class="fa fa-shopping-cart"></i> Transactions</h4>

        <table class="table table-hover mt-3">
            <thead>
                <tr><th>Item</th><th>Buyer</th><th>Qty</th><th>Total</th><th>Date</th></tr>
            </thead>
            <tbody>
                {% for t in sold_transactions %}
                <tr>
                    <td>{{ t.item.name }}</td>
                    <td>{{ t.buyer.username }}</td>
                    <td>{{ t.quantity }}</td>
                    <td>₹{{ t.total_price }}</td>
                    <td>{{ t.date|date:"M d, Y H:i" }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="5" class="text-center text-muted">No transactions yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

</div>
{% endblock %}


{% block extra_js %}
<script>
function showSection(x){
    ['dashboard','requests','profile','transactions'].forEach(s=>{
        document.getElementById(s+'-section').classList.add('d-none');
    });
    document.getElementById(x+'-section').classList.remove('d-none');
}

function filterProducts(){
    let search=document.getElementById("productSearch").value.toLowerCase();
    document.querySelectorAll("#productsTable tbody tr").forEach(row=>{
        row.style.display=row.innerText.toLowerCase().includes(search)? "":"none";
    });
}

function getCookie(name){
    let cookieValue=null;
    if(document.cookie && document.cookie!==""){
        const cookies=document.cookie.split(";");
        for(let cookie of cookies){
            cookie=cookie.trim();
            if(cookie.startsWith(name+"=")){
                cookieValue=decodeURIComponent(cookie.substring(name.length+1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrfToken=getCookie("csrftoken");

function editRow(id){
    document.getElementById("edit-btn-"+id).classList.add("d-none");
    document.getElementById("save-btn-"+id).classList.remove("d-none");

    ["name","desc","qty","price"].forEach(f=>{
        document.getElementById(f+"-display-"+id).classList.add("d-none");
        document.getElementById(f+"-input-"+id).classList.remove("d-none");
    });
}

function saveEdit(id){
    let data={
        name:document.getElementById("name-input-"+id).value,
        description:document.getElementById("desc-input-"+id).value,
        quantity:document.getElementById("qty-input-"+id).value,
        price:document.getElementById("price-input-"+id).value,
    };

    fetch(`/shopkeeper/product/${id}/edit/`,{
        method:"POST",
        headers:{ "X-CSRFToken":csrfToken, "X-Requested-With":"XMLHttpRequest" },
        body:new URLSearchParams(data)
    })
    .then(res=>res.json())
    .then(r=>{
        if(r.success){
            document.getElementById("name-display-"+id).innerText=r.name;
            document.getElementById("desc-display-"+id).innerText=r.description;
            document.getElementById("qty-display-"+id).innerText=r.quantity;
            document.getElementById("price-display-"+id).innerText=r.price;
        }

        ["name","desc","qty","price"].forEach(f=>{
            document.getElementById(f+"-display-"+id).classList.remove("d-none");
            document.getElementById(f+"-input-"+id).classList.add("d-none");
        });

        document.getElementById("edit-btn-"+id).classList.remove("d-none");
        document.getElementById("save-btn-"+id).classList.add("d-none");
    });
}

function handleRequest(id, action){
    let msg=document.getElementById(`reply-input-${id}`).value;

    fetch("",{
        method:"POST",
        headers:{ "X-CSRFToken":csrfToken, "X-Requested-With":"XMLHttpRequest" },
        body:new URLSearchParams({ request_id:id, action:action, reply_message:msg })
    })
    .then(res=>res.json())
    .then(r=>{
        if(r.success){
            document.getElementById("reply-"+id).innerText=r.reply_message;
        }
    });
}
</script>
{% endblock %}
